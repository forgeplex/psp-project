# Channels 模块 UI/UX 设计文档

> **状态**: 设计中  
> **版本**: v0.1  
> **更新**: 2026-02-03  

---

## 1. 设计概述

### 1.1 模块定位
Channels（渠道管理）是 PSP 系统的核心配置模块，负责管理支付渠道的生命周期、路由策略和健康监控。

### 1.2 设计原则
- **清晰状态展示**：渠道状态（健康/异常/维护）一目了然
- **配置即代码**：复杂配置提供可视化编辑器，降低使用门槛
- **操作可回退**：关键操作（删除/状态切换）需要二次确认

---

## 2. 信息架构

### 2.1 页面结构

```
/channels
├── /                         # 渠道列表页
│   ├── 渠道表格（含健康状态）
│   ├── 筛选栏（状态/提供商/类型）
│   └── 批量操作（启用/禁用/删除）
├── /create                   # 创建渠道
│   ├── 基本信息（编码/名称/提供商）
│   ├── 动态配置表单（基于 provider schema）
│   └── 限额设置
├── /:channelId               # 渠道详情
│   ├── 概览 Tab（关键指标 + 状态卡片）
│   ├── 配置 Tab（只读配置展示）
│   ├── 统计 Tab（24h 交易量/成功率）
│   └── 关联策略（使用此渠道的路由策略）
└── /:channelId/edit          # 编辑渠道

/channels/routing-strategies
├── /                         # 策略列表
│   ├── 策略卡片（优先级排序）
│   ├── 拖拽排序功能
│   └── 匹配率统计
├── /create                   # 创建策略
│   ├── 基本信息
│   ├── 规则引擎（可视化构建器）
│   ├── 目标渠道（权重配置）
│   └── 故障转移设置
└── /:strategyId              # 策略详情/编辑

/channels/health-checks
├── /                         # 检查记录列表
│   ├── 时间线视图
│   └── 手动触发按钮
└── /:checkId                 # 检查详情（响应详情）

/channels/providers
├── /                         # 提供商列表（卡片网格）
└── /:providerId              # 提供商详情 + 关联渠道
```

---

## 3. 页面详细设计

### 3.1 渠道列表页 (/channels)

#### 布局
- **顶部**: 页面标题 + 创建按钮 + 刷新按钮
- **筛选栏**: 状态 Tabs (全部/活跃/禁用/维护) + 提供商下拉 + 搜索框
- **主内容**: 表格展示

#### 表格字段
| 字段 | 说明 | 交互 |
|------|------|------|
| 状态图标 | 健康状态 (healthy/degraded/unhealthy) | hover 显示上次检查时间 |
| 编码 | 渠道唯一标识 | 点击跳转详情 |
| 名称 | 显示名称 | - |
| 提供商 | 图标 + 名称 | hover 显示提供商详情 |
| 类型 | payment/payout/combined 标签 | - |
| 状态 | active/inactive/maintenance Badge | 可点击快速切换 |
| 成功率 | 24h 成功率进度条 | - |
| 响应时间 | avg_response_ms | - |
| 操作 | 编辑/删除/启用/禁用 | 下拉菜单 |

#### 状态切换交互
- active → maintenance: 直接切换（维护模式不影响现有交易）
- active → inactive: 确认弹窗（"禁用后新交易将无法使用该渠道"）
- 批量操作：选择多行后显示批量操作栏

---

### 3.2 渠道创建/编辑页

#### 表单结构
```
Step 1: 基本信息
├── 渠道编码* (输入框，大写验证)
├── 渠道名称* (输入框)
├── 所属提供商* (选择器，搜索下拉)
├── 渠道类型* (单选: 支付/代付/综合)
└── 优先级 (数字输入，1-9999)

Step 2: 渠道配置 (动态表单)
├── 根据 provider.config_schema 自动生成
├── 支持类型: string/number/enum/password/json
└── 字段验证（必填、格式、范围）

Step 3: 交易限额
├── 单笔最小金额 (金额输入)
├── 单笔最大金额 (金额输入)
├── 日限额 (金额输入，可选)
└── 月限额 (金额输入，可选)
```

#### 动态表单规则
```typescript
// Schema 示例
interface ConfigSchema {
  type: 'string' | 'number' | 'enum' | 'password' | 'json';
  label: string;
  required?: boolean;
  validation?: {
    pattern?: string;      // regex for string
    min?: number;          // for number
    max?: number;
    options?: { label: string; value: string }[];  // for enum
  };
  placeholder?: string;
  helpText?: string;
}
```

---

### 3.3 渠道详情页

#### Tab 导航
- **概览** (默认): 关键指标卡片 + 最近活动
- **配置**: 只读展示所有配置项
- **统计**: 24h/7d/30d 交易量、成功率趋势图
- **路由策略**: 使用此渠道的策略列表

#### 概览 Tab 内容
```
┌─────────────────────────────────────────────────────────────┐
│ 状态卡片                                                    │
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│ │ 当前状态    │ │ 24h 成功率  │ │ 平均响应    │           │
│ │ [大Badge]   │ │ [进度环]    │ │ [数字]ms   │           │
│ └─────────────┘ └─────────────┘ └─────────────┘           │
├─────────────────────────────────────────────────────────────┤
│ 基本信息                                                    │
│ 编码/名称/提供商/类型/创建时间/更新时间                     │
├─────────────────────────────────────────────────────────────┤
│ 交易限额                                                    │
│ 单笔: ¥0.01 - ¥50,000 / 日限额: ¥1,000,000                 │
├─────────────────────────────────────────────────────────────┤
│ 最近健康检查                                                │
│ 时间线展示最近 5 次检查结果                                 │
└─────────────────────────────────────────────────────────────┘
```

---

### 3.4 路由策略列表页

#### 布局特点
- **优先级排序**：列表按 priority 升序排列
- **拖拽排序**：可拖拽调整优先级（批量保存或实时保存？待确认）
- **策略卡片**：每条策略以卡片形式展示，包含匹配条件预览

#### 策略卡片结构
```
┌────────────────────────────────────────────────────┐
│ [拖拽手柄] 策略名称                          [状态] │
│ 描述文字...                                        │
├────────────────────────────────────────────────────┤
│ 匹配条件: amount > 1000 AND currency = CNY        │
│ 目标渠道: 支付宝(80%) → 微信支付(20%)              │
│ 故障转移: 启用 → 银联快捷                          │
├────────────────────────────────────────────────────┤
│ 24h 匹配: 5,230 次 (匹配率 35%)              [编辑] │
└────────────────────────────────────────────────────┘
```

---

### 3.5 路由策略创建/编辑页

#### 核心挑战：规则引擎可视化

**方案 A：可视化构建器（推荐）**
```
┌─────────────────────────────────────────────────────────────┐
│ 规则条件                                                    │
│                                                             │
│  满足 [全部/任意] 以下条件：                                │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ [字段选择 ▼]  [操作符 ▼]  [值输入]           [删除] │   │
│  │   amount    │    >      │   1000                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ [currency ▼]  [等于 ▼]  [CNY ▼]              [删除] │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  + 添加条件                                                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**字段选择器选项**：
- 交易字段: amount, currency, payment_method
- 用户字段: user.vip_level, user.registration_date
- 设备字段: device.type, device.os
- 风控字段: risk.score, risk.flags

**操作符映射**：
| 类型 | 操作符 |
|------|--------|
| 数字 | >, <, >=, <=, =, between |
| 字符串 | =, !=, contains, startsWith, in |
| 枚举 | =, !=, in, not in |
| 布尔 | = |

#### 目标渠道配置
```
目标渠道 (按权重分配流量):

┌──────────────────────────────────────────────────────────────┐
│ 支付宝                              [80%] [========  ] [删除] │
│ └─ 故障转移至: [微信支付 ▼]                                   │
├──────────────────────────────────────────────────────────────┤
│ 微信支付                            [20%] [==        ] [删除] │
│ └─ 故障转移至: [无 ▼]                                         │
└──────────────────────────────────────────────────────────────┘

+ 添加目标渠道

故障转移配置:
☑ 启用故障转移
  最大重试: [3] 次
  重试间隔: [500] ms
  最终回退渠道: [银联快捷 ▼]
```

---

### 3.6 健康检查页面

#### 检查记录列表
- **视图切换**: 列表视图 / 时间线视图
- **筛选**: 按渠道 / 按状态 / 按时间范围
- **手动触发**: 选择渠道 → 触发检查 → 显示结果

#### 检查详情
```
检查时间: 2026-02-03 10:00:00
检查渠道: 微信支付 (WECHAT_PAY)
检查结果: ✅ 健康
响应时间: 120ms

请求详情:
┌────────────────────────────────────────────────────────────┐
│ POST /health-check                                         │
│ {                                                          │
│   "app_id": "wx123456789",                                │
│   "mch_id": "1234567890"                                  │
│ }                                                          │
└────────────────────────────────────────────────────────────┘

响应详情:
┌────────────────────────────────────────────────────────────┐
│ HTTP 200 OK                                                │
│ Response Time: 120ms                                       │
│ {                                                          │
│   "return_code": "SUCCESS",                               │
│   "result_code": "SUCCESS"                                │
│ }                                                          │
└────────────────────────────────────────────────────────────┘
```

---

### 3.7 提供商页面

#### 提供商列表（卡片网格）
```
┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐
│ [微信支付 Logo]  │ │ [支付宝 Logo]    │ │ [银联 Logo]      │
│                  │ │                  │ │                  │
│ 财付通           │ │ 支付宝           │ │ 中国银联         │
│ 3 个渠道         │ │ 2 个渠道         │ │ 1 个渠道         │
│                  │ │                  │ │                  │
│ [查看详情]       │ │ [查看详情]       │ │ [查看详情]       │
└──────────────────┘ └──────────────────┘ └──────────────────┘
```

#### 提供商详情
- 基本信息（名称/编码/官网/文档链接）
- 支持的渠道类型
- 配置字段 Schema 展示
- 关联渠道列表

---

## 4. 组件规范

### 4.1 渠道状态 Badge

| 状态 | 颜色 | 说明 |
|------|------|------|
| active | green | 正常使用 |
| inactive | gray | 已禁用 |
| maintenance | yellow | 维护中 |

### 4.2 健康状态指示器

| 状态 | 图标 | 颜色 |
|------|------|------|
| healthy | ● | green |
| degraded | ◐ | yellow |
| unhealthy | ● | red |
| unknown | ○ | gray |

### 4.3 规则引擎组件

```typescript
// 组件接口
interface RuleBuilderProps {
  value: RuleGroup;
  onChange: (rules: RuleGroup) => void;
  fields: FieldDefinition[];
}

interface FieldDefinition {
  key: string;
  label: string;
  type: 'number' | 'string' | 'enum' | 'boolean';
  operators: Operator[];
  options?: Option[];  // for enum
}
```

---

## 5. 待确认事项

1. **规则引擎 UI 方案**：可视化构建器 vs JSON 编辑器？（倾向可视化）
2. **优先级排序**：拖拽后实时保存 or 批量提交？（倾向批量）
3. **健康检查自动刷新**：WebSocket 实时更新 or 定时轮询？
4. **Provider Schema 字段类型**：是否支持嵌套对象/数组？

---

## 6. 交付清单

- [ ] 设计文档（本文档）
- [ ] 页面原型/线框（可选）
- [ ] React 组件代码
  - [ ] 渠道管理页面
  - [ ] 路由策略页面（含规则引擎）
  - [ ] 健康检查页面
  - [ ] 提供商页面
- [ ] API Hooks 封装
- [ ] 单元测试

